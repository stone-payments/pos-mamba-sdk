<svelte:document on:click="_handleDocumentClick(event)" />

{#if isFocused}
  <div class="keyboard">
    <div class="keys" class:with-math="isMathKeyboard">
      {#each keys as key}
        <button class="key" on:click="runInstanceKey(key)">
          {#if key.code === "delete"}
            <img class="icon" src="{deleteIcon}" alt="delete icon numeric keyboard" />
          {:elseif key.code === "confirmation"}
            <img class="icon" src="{confirmIcon}" alt="confirm icon numeric keyboard" />
          {:else}
            {key.code}
          {/if}
        </button>
      {/each}
    </div>

    {#if isMathKeyboard}
      <div class="keyboard-math">
        {#each mathKeys as key}
          <button class="key" on:click="runInstanceKey(key)">{key.code}</button>
        {/each}
      </div>
    {/if}
  </div>
{/if}

<script>

  import deleteIcon from './assets/num_delete.png';
  import confirmIcon from './assets/num_ok.png';

  // Libs
  import { VIRTUAL_KEYBOARD } from './libs/virtualKeyboard.js';

  // Controllers
  import VirtualKeyboardController from './Controllers/virtualKeyboard/VirtualKeyboardController.js';

  let controller;

  export default {
    helpers: {
      deleteIcon,
      confirmIcon,
    },
    computed: {
      _inputProps: (
        props = { bgColor, label, placeholder, textColor, value, validation },
      ) => ({ ...props }),
      isMathKeyboard: ({ type }) => {
        return type === "math"
      }
    },
    data() {
      return {
        isFocused: false,
        inputRef: {},
        keys: VIRTUAL_KEYBOARD.KEYS,
        mathKeys: VIRTUAL_KEYBOARD.MATH,
      };
    },
    oncreate() {
     controller = new VirtualKeyboardController(this);
    },
    methods: {
      runInstanceKey(instance) {
        instance.onClick(controller);
      },
      openKeyboard(inputRef) {
        controller.openKeyboard(inputRef);
      },
      closeKeyboard() {
        controller.closeKeyboard();
      },
      _handleDocumentClick(event) {
        this._handleClickOutside(event);
      },
      /**
       *
       * @param {PointerEvent} event
       * @private
       */
      _handleClickOutside(event) {
        const { target } = event;

        const offsetParentClassList = Array.from(target.offsetParent ? target.offsetParent.classList : []);

        const hasClickedOutside = offsetParentClassList.every(className => className !== 'keyboard');
        const isInputElement = target instanceof HTMLInputElement;

        if (hasClickedOutside && !isInputElement) {
          this.set({ isFocused: false });
        }
      },
    },
  };
</script>

<style type="text/postcss">
  .keyboard {
    width: 100%;
    min-width: 80%;
    max-height: 320px;

    border-top: 1px solid $gray700;
    background-color: $neutral50;

    position: fixed;
    bottom: 0;

    box-sizing: border-box;
  }

  .key {
    width: calc(100% / 3);
    height: auto;
    border: 0;
    font-size: 20px;
    line-height: 40px;
    color: $neutral700;
    background-color: transparent;
  }

  .keys {
    width: 100%;

    &.with-math {
      max-width: 79%;
      display: inline-block;
      border-right: 2px solid rgba(0, 0, 0, 0.25);
      .key {
        line-height: 70px;
      }
    }
  }
  .keyboard-math {
    max-width: 20%;
    display: inline-block;

    .key {
      width: 100%;
      line-height: 51px;
      font-size: 30px;
    }
  }

  .icon {
    max-width: 20px;
    max-height: 19px;
  }
</style>
