<svelte:window on:keyup="selectRowItems(event)" bind:scrollY="scrollY" />

<div>
  {#if dataSection}
    {#each dataSection as section }
      {#if section.data}
        {#if section.title}
          {#if renderTitle}
            <svelte:component this="{renderTitle}" title={section.title} />
            {:else}
              <div class="row">
                <div class="title">{section.title}</div>
              </div>
          {/if}
        {/if}

        {#each section.data as item, index}
          <Parent
            on:create="register(this, index)"
            data={item}
            isActive={isActive}
            key={index}
            renderItem={renderItem}
          />
        {/each}

        {#if separator}
          <svelte:component this="{separator}"/>
          {:else}
            <div class="separator"></div>
        {/if}
      {/if}
    {/each}
  {/if}

</div>

<script>

  import { selectRowItem } from './helpers.js';

  export default {
    components: {
      Parent: './parent.html',
    },
    data() {
      return {
        renderItem: null,
        renderTitle: null,
        dataSection: null,
        data: null,
        separator: null,
        isActive: false,
        elementsRefs: [],
        selectedIndex: null,
      };
    },
    oncreate(){
      const { data, dataSection } = this.get();

      if(data && !dataSection) {
        this.set({
          dataSection: [{
            title: null,
            data
          }]
        })
      }

      console.log(this.get())

    },
    methods: {
      register(element, index) {
        const { elementsRefs, dataSection } = this.get();

        elementsRefs.push({
          element,
          index,
        });
      },
      selectRowItems(event) {
        const { keyCode } = event;

        /**
         * KeyCode -> KeyName dictionary
         *
         *  38: 'keyup'
         *  40: 'keydown'
         *
        */
        if(keyCode === 38 || keyCode === 40) {
          const { scrollY, selectedIndex, elementsRefs } = this.get();

          const screenY = scrollY // __BROWSER__ ? document.querySelector('#apps-container') : scrollY ;

          const keyAction = keyCode === 38 ? 'up' : 'down';

          const itemSelected = selectRowItem(elementsRefs, selectedIndex, scrollY, keyAction);

          this.fire('active', {item: elementsRefs[itemSelected]});

          this.set({ selectedIndex: itemSelected });
        }
      },
    },
  };
</script>

<style type="text/postcss">
  .row {
    display: block;
    padding: 10px 20px;
    margin: 0;
    line-height: 1.5rem;
    background: #fff;
    border-bottom: 1px solid #f4f4f4;
    color: #494949;

    .title {
      color: $green500;
      font-size: 1.2rem;
    }
  }
  .separator {
    margin-bottom: 15px;
  }
</style>
