<Dialog
  ref:dialog
  {..._dialogProps}
  bind:isOpen
  on:open
  on:close
  className="mb-confirmation-dialog"
  on:keyup|capture="keyHandler(event)"
  contentStyle={[
    'padding: 0 12px'
  ]}
>
  <slot></slot>
  <div slot="extra">
    <table class="actions" class:has-labels="_hasLabel">
      <tr>
        <td>
          {#if _hasLabel}
            <button
              class="action negative"
              style={_negativeLabelStyle}
              on:click="close('negative', 'TOUCH')"
              shortcut="close"
            >
              {negativeLabel}
            </button>
          {:else}
            <div class="action" on:click="close('negative', 'TOUCH')" shortcut="close">
              <RoundIcon
                symbol="close"
                size={buttonSize}
                borderRadius="11px"
                bgColor={red400}
              />
            </div>
          {/if}
        </td>
        <td class="spacer"></td>
        <td>
          {#if _hasLabel}
            <button
              class="action positive"
              style={_positiveLabelStyle}
              on:click="close('positive', 'TOUCH')"
              shortcut="enter"
            >
              {positiveLabel}
            </button>
          {:else}
            <div class="action" on:click="close('positive', 'TOUCH')" shortcut="enter">
              <RoundIcon
                symbol="check"
                size={buttonSize}
                borderRadius="11px"
                bgColor={green500}
              />
            </div>
          {/if}
        </td>
      </tr>
    </table>
    <slot name="footer"></slot>
  </div>
</Dialog>

<script>
  import Keyboard from '@mamba/keyboard/api/keyboard.js';
  import { KEYBOARD } from '@mamba/core';
  import { green500, red400 } from '@mamba/styles/colors';

  export default {
    components: {
      RoundIcon: '@mamba/icon/Round.html',
      Dialog: './Dialog.html',
    },
    helpers: {
      green500,
      red400,
    },
    data() {
      return {
        isOpen: false,
        positiveLabel: null,
        negativeLabel: null,
        primaryColor: green500,
        buttonSize: 'giant',
      };
    },
    computed: {
      _dialogProps: ({ positiveLabel, negativeLabel, primaryColor, ...props }) => props,
      _hasLabel: ({ negativeLabel, positiveLabel }) => !!(negativeLabel && positiveLabel),
      _positiveLabelStyle: ({ _hasLabel, primaryColor }) => {
        if (!_hasLabel || !primaryColor) {
          return;
        }

        return `color: #fff; background-color: ${primaryColor}; border-color: ${primaryColor};`;
      },
      _negativeLabelStyle: ({ _hasLabel, primaryColor }) => {
        if (!_hasLabel || !primaryColor) {
          return;
        }

        return `color: ${primaryColor}; border-color: ${primaryColor}; `;
      },
    },
    methods: {
      keyHandler(e) {
        if (!this.get().isOpen) return;
        const keyCode = Keyboard.parseEventKeyCode(e);

        const isClose = keyCode === KEYBOARD.KEY_CODES.CLOSE;
        const isEnter = keyCode === KEYBOARD.KEY_CODES.ENTER;

        if (isClose || isEnter) {
          if (__DEV__ || __DEBUG_LVL__ >= 1) {
            console.log(`[@mamba/dialog/Confirmation.html] !! stopping propagation of key.`);
          }
          e.stopImmediatePropagation();
          e.preventDefault();

          if (isEnter) this.close('positive', 'KEYBOARD');
          if (isClose) this.close('negative', 'KEYBOARD');
        }
      },
      open(duration) {
        return this.refs.dialog.open(duration);
      },
      close(event, telemetryEmitType) {
        return this.refs.dialog.close().then(() => {
          if (event) {
            this.fire(event, {
              telemetryEmitType,
            });
          }
        });
      },
    },
  };
</script>

<style>
  :global(.mb-confirmation-dialog:not(.is-wide)) .actions {
    margin: 28px auto 0;
  }

  :global(.mb-confirmation-dialog.is-wide .message) {
    margin-bottom: 10px;
  }

  :global(.mb-confirmation-dialog.is-wide .extra) {
    margin-bottom: 10px;
    width: 100%;
  }

  .actions {
    table-layout: fixed;

    &.has-labels {
      width: 100%;
    }
  }

  .action {
    display: block;
    background: transparent;
    font-weight: bold;

    .actions.has-labels & {
      border: 1px solid $dialog-confirmation-primary-color;
      border-radius: 3px;
      padding: 10px 16px;
      color: $dialog-confirmation-primary-color;

      &.positive {
        background-color: $dialog-confirmation-primary-color;
        color: $dialog-confirmation-text-color;
      }
    }
  }

  .spacer {
    width: 20px;

    .actions.has-labels & {
      width: 10px;
    }
  }

  button {
    width: 100%;
  }
</style>
