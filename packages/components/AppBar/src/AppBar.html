<header class="appbar" {style}>
  <div class="content">
    {#if !isAtHome}
      <div class="icon-left" on:click="goback()">
        <Icon symbol="chevron-left" width="10px" color={isAppLocked ? '#dbdbdb' : textColor} />
      </div>
    {/if}

    {#if title}
      <div class="title">{title}</div>
    {/if}

    <div class="icon-right" on:click="gohome()">
      <Icon symbol={homeIcon} color={isAppLocked ? '#dbdbdb' : textColor}/>
    </div>
  </div>
</header>

<script>
  import { getHistory } from 'svelte-routing';

  export default {
    components: {
      Icon: '@mamba/icon',
    },
    data() {
      return {
        _location: undefined,
        title: undefined,
        textColor: '#425963',
        bgColor: '#f2f2f2',
      };
    },
    computed: {
      style({ bgColor, textColor }) {
        return [`color:${textColor}`, `background-color:${bgColor}`].join(';');
      },
      isAtHome: ({ _location }) => _location === '/',
      homeIcon: ({ isAtHome }) => (isAtHome ? 'home' : 'app-home'),
      isAppLocked: ({ $__meta__ }) => $__meta__.locked,
    },
    oncreate() {
      const history = getHistory();

      /** Listen for route changes */
      if (history) {
        this.set({ _location: history.location.pathname });
        history.listen(location => {
          this.set({ _location: location.pathname });
        });
      }

      /** Listen for app title changes */
      if (this.store) {
        this.store.meta.on('title', title => this.set({ title }));
      }
    },
    methods: {
      gohome() {
        if (this.store && this.store.meta.isAppLocked()) {
          return;
        }

        const { isAtHome } = this.get();
        if (isAtHome) {
          return this.store.meta.closeApp();
        }

        getHistory().push('/');
      },
      goback() {
        if (this.store && this.store.meta.isAppLocked()) {
          return;
        }

        getHistory().goBack();
      },
    },
  };
</script>

<style type="text/postcss">
  @import '@mamba/styles/colors.pcss';

  $height: 36px;
  $item-horizontal-margin: 8px;

  $background-color: $white;
  $border-color: $grey-light;

  $font-size: 0.9rem;
  $font-color: $white;

  .appbar {
    width: 100%;
    position: relative;
    border-bottom: 2px solid #d0d0d0;
  }

  .title {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    padding: 0;
    margin: 0;
    max-width: 154px;
    white-space: nowrap;
    overflow: hidden;
    color: inherit;
    font-size: $font-size;
    font-weight: 600;
    line-height: 1;
    text-align: center;
    text-transform: uppercase;
    text-overflow: ellipsis;
    user-select: none;
  }

  .content {
    padding-left: $item-horizontal-margin;
    padding-right: $item-horizontal-margin;
    min-height: $height;
  }

  .icon {
    cursor: pointer;
    height: $height;
    width: 34px;
  }

  .icon-left,
  .icon-right {
    position: absolute;
    top: 0;
    display: flex;
    align-items: center;
    height: 100%;
    padding-left: $item-horizontal-margin;
    padding-right: $item-horizontal-margin;
    width: 40px;
  }

  .icon-left {
    left: 0;
  }

  .icon-right {
    padding-left: $item-horizontal-margin;
    padding-right: $item-horizontal-margin;
    right: 0;
  }
</style>
